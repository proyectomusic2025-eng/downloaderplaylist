services:
  # 1. Servicio de Broker Redis (para Celery)
  - type: redis
    name: musicdown-redis
    plan: free

  # 2. Servicio Web Principal (Aplicaci贸n Django)
  - type: web
    name: musicdown-app
    # Repo: Usado para obtener el c贸digo fuente
    repo: https://github.com/proyectomusic2025-eng/downloaderplaylist
    branch: main 
    plan: free
    rootDir: . 
    env: python
    
    #  CORRECCIN DE TIEMPO: Sleep largo para la base de datos externa.
    # El sleep ahora espera la base de datos que crearemos manualmente.
    buildCommand: |
      pip install -r requirements.txt
      echo "Esperando 30 segundos para la conexi贸n a la base de datos (creada manualmente)..."
      sleep 30 
      python manage.py migrate
      
    # El comando para iniciar el servidor Gunicorn
    startCommand: gunicorn musicdown.wsgi:application

    # Conexi贸n de variables de entorno
    envVars:
      # **IMPORTANTE:** Aqu铆 solo hay un marcador de posici贸n. 
      # Debes establecer la DATABASE_URL manualmente en el Dashboard de Render (Paso 3).
      - key: DATABASE_URL
        value: "PENDIENTE_DE_CONFIGURACION_MANUAL"
        
      # Conecta el broker de Celery
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: musicdown-redis
          property: connectionString
          
      # Conecta el backend de resultados de Celery (usa el mismo broker)
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: musicdown-redis
          property: connectionString
          
      # Variables esenciales de Django
      - key: DEBUG
        value: "False"
      - key: DJANGO_SECRET_KEY
        generateValue: true
      # El dominio sin https:// ni /
      - key: ALLOWED_HOSTS
        value: "downloaderplaylist.onrender.com" 
        
      # Otras variables de entorno que tienes en settings.py
      - key: STRIPE_SECRET_KEY
        value: "sk_live_..." 
      - key: STRIPE_PUBLISHABLE_KEY
        value: "pk_live_..."
      - key: KO_FI_WEBHOOK_SECRET
        value: "tu_secreto_ko_fi"
      - key: PREPACKAGED_EXE_URL
        value: "https://ko-fi.com/downloaderplaylist"
        
      # Configura el resto de tus variables de EMAIL
      - key: EMAIL_HOST
        value: "smtp.gmail.com"
      - key: EMAIL_PORT
        value: "587"
      - key: EMAIL_HOST_USER
        value: "proyectomusic2025@gmail.com"
      - key: EMAIL_HOST_PASSWORD
        value: "Aferneysg1518" 
      - key: EMAIL_USE_TLS
        value: "True"
```
