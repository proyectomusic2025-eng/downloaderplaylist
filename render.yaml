services:
  # 1. Servicio de Base de Datos PostgreSQL
  - type: pserv
    name: musicdown-db
    plan: free
    databaseName: musicdown_db
    user: musicdown_user
    max_version: 16

  # 2. Servicio de Broker Redis (para Celery)
  - type: redis
    name: musicdown-redis
    plan: free

  # 3. Servicio Web Principal (Aplicaci√≥n Django)
  - type: web
    name: musicdown-app
    # Repo: Usado para obtener el c√≥digo fuente
    repo: https://github.com/proyectomusic2025-eng/downloaderplaylist
    branch: main 
    plan: free
    rootDir: . 
    env: python
    
    # üåü CORRECCI√ìN DEFINITIVA: BUCLE DE REINTENTO PARA MIGRACIONES üåü
    # Intenta 'migrate' 5 veces, esperando 5 segundos entre cada intento si falla.
    buildCommand: |
      pip install -r requirements.txt
      
      MAX_RETRIES=5
      RETRY_DELAY=5
      
      for i in $(seq 1 $MAX_RETRIES); do
        echo "Intento $i de $MAX_RETRIES: Ejecutando migraciones..."
        python manage.py migrate
        
        # Verifica el c√≥digo de salida (0 es √©xito)
        if [ $? -eq 0 ]; then
          echo "‚úÖ Migraciones completadas con √©xito."
          break
        elif [ $i -eq $MAX_RETRIES ]; then
          echo "‚ùå Fallo despu√©s de $MAX_RETRIES intentos. Abortando el build."
          exit 1
        else
          echo "‚ö†Ô∏è Fallo en la conexi√≥n a la base de datos. Esperando $RETRY_DELAY segundos..."
          sleep $RETRY_DELAY
        fi
      done
      
    # El comando para iniciar el servidor Gunicorn
    startCommand: gunicorn musicdown.wsgi:application

    # Conexi√≥n autom√°tica de variables de entorno
    envVars:
      # Conecta la base de datos
      - key: DATABASE_URL
        fromDatabase: musicdown-db
        
      # Conecta el broker de Celery
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: musicdown-redis
          property: connectionString
          
      # Conecta el backend de resultados de Celery (usa el mismo broker)
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: musicdown-redis
          property: connectionString
          
      # Variables esenciales de Django
      - key: DEBUG
        value: "False"
      - key: DJANGO_SECRET_KEY
        generateValue: true
      # El dominio sin https:// ni /
      - key: ALLOWED_HOSTS
        value: "downloaderplaylist.onrender.com" 
        
      # Otras variables de entorno que tienes en settings.py
      - key: STRIPE_SECRET_KEY
        value: "sk_live_..." 
      - key: STRIPE_PUBLISHABLE_KEY
        value: "pk_live_..."
      - key: KO_FI_WEBHOOK_SECRET
        value: "tu_secreto_ko_fi"
      - key: PREPACKAGED_EXE_URL
        value: "https://ko-fi.com/downloaderplaylist"
        
      # Configura el resto de tus variables de EMAIL
      - key: EMAIL_HOST
        value: "smtp.gmail.com"
      - key: EMAIL_PORT
        value: "587"
      - key: EMAIL_HOST_USER
        value: "proyectomusic2025@gmail.com"
      - key: EMAIL_HOST_PASSWORD
        value: "Aferneysg1518" 
      - key: EMAIL_USE_TLS
        value: "True"
